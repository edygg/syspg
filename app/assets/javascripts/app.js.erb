app = angular.module('SyspgApp', ['ngMaterial', 'ui.router', 'ng-token-auth']);

app.config(['$stateProvider', '$urlRouterProvider', '$mdThemingProvider', '$authProvider', function($stateProvider, $urlRouterProvider, $mdThemingProvider, $authProvider) {
  /* Router Paths */
  // Home
  $urlRouterProvider.otherwise('/');

  $stateProvider
    .state('home', {
      url: '/',
      templateUrl: "<%= asset_path('home/index.html') %>",
      controller: "HomeController",
      controllerAs: "homeCtrl"
    })
    .state('user', {
      url: '/users',
      template: '<ui-view/>',
      abstract: true,
    })
    .state('user.sign_in', {
      url: '/sign_in',
      templateUrl: "<%= asset_path('users/sign_in.html') %>"
    })
    .state('user.sign_up_choice', {
      url: '/sign_up_choice',
      templateUrl: "<%= asset_path('users/sign_up_choice.html') %>"
    })
    .state('user.company_sign_up', {
      url: '/company_sign_up',
      templateUrl: "<%= asset_path('users/company_sign_up.html'); %>",
      controller: "CompanySignUpController",
      controllerAs: 'companySignUpCtrl'
    })
    .state('user.sign_up', {
      url: '/sign_up',
      templateUrl: "<%= asset_path('users/sign_up.html') %>",
      controller: 'UserSignUpController',
      controllerAs: 'userSignUpCtrl'
    });
  /* End Router Paths */

  /* Theme */
  $mdThemingProvider.theme('default')
    .primaryPalette('indigo')
    .accentPalette('red', {
      'default': '400'
    });
  /* End Theme */

  /* Token Auth */
  $authProvider.configure({
    apiUrl: 'http://syspg-153073.nitrousapp.com'
  });
  /* End Token Auth */
}]);

/* Controllers */
app.controller('HomeController', function() {
  $('.slider').slider({ indicators: false });
  this.homeData = {
    options: 30,
    usersRegistered: 100
  };
});

app.controller('UserSignUpController', ['$auth', function($auth) {
  this.newUser = {};

  this.submitRegistration = function(userInfo) {
    console.log("Entre al evento");
    $auth.submitRegistration(userInfo)
      .then(function(resp) {
        console.log(resp);
      })
      .catch(function(resp) {
        console.log(resp);
      });
  };
}]);

app.controller('CompanySignUpController',
               ['$auth', '$http', '$mdDialog', '$location', function($auth, $http, $mdDialog, $location) {
  this.newUser = {};
  this.companyInfo = {};

  this.submitRegistration = function(userInfo, companyInfo) {
    $auth.submitRegistration(userInfo)
      .then(function(response) {
        companyInfo.user_id = response.data.data.id
        $http.post('/companies.json', companyInfo)
          .then(function(response) {
            $mdDialog.show($mdDialog.alert({
              title: "Mensaje de confirmación",
              textContent: "Para confirmar tus datos hemos enviado un correo electrónico.",
              ok: 'Cerrar'
            })).finally(function(){
              $location.path('/');
            });
          }, function(errors) {
            console.log(errors);
          });
      })
      .catch(function(response) {
        console.log('Soy el error del registro');
        var errors = response.data.errors.full_messages;
        var errorString = errors.join("<br>");
        $mdDialog.show($mdDialog.alert({
          title: "Errores",
          textContent: errorString,
          ok: 'Entiendo'
        }));
      });
  };
}]);
/* End Controllers */

/* Directives */
app.directive('mainNavbar', function() {
  return {
    restrict: 'E',
    templateUrl: "<%= asset_path('shared/navbar.html') %>"
  };
});
/* End Directives */
